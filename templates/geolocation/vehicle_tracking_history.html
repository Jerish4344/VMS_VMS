{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
  Tracking History: {{ vehicle.license_plate }} | {{ block.super }}
{% endblock %}

{% block extra_css %}
<style>
  .history-container {
    padding: 20px;
  }
  
  .vehicle-info-card {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    overflow: hidden;
  }
  
  .vehicle-header {
    background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
    color: white;
    padding: 20px;
  }
  
  .vehicle-header h1 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
  }
  
  .vehicle-details {
    padding: 20px;
  }
  
  .detail-item {
    display: inline-block;
    margin-right: 30px;
    margin-bottom: 10px;
  }
  
  .detail-label {
    font-weight: 600;
    color: #5a5c69;
  }
  
  .detail-value {
    color: #3a3b45;
    margin-left: 8px;
  }
  
  .date-filter-card {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    padding: 20px;
  }
  
  .filter-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #5a5c69;
    margin-bottom: 15px;
  }
  
  .filter-form {
    display: flex;
    align-items: end;
    gap: 15px;
    flex-wrap: wrap;
  }
  
  .form-group {
    flex: 1;
    min-width: 200px;
  }
  
  .form-group label {
    display: block;
    font-weight: 600;
    color: #5a5c69;
    margin-bottom: 5px;
    font-size: 0.9rem;
  }
  
  .form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d3e2;
    border-radius: 5px;
    font-size: 0.9rem;
  }
  
  .stats-row {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .stat-card {
    flex: 1;
    min-width: 200px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 20px;
    text-align: center;
  }
  
  .stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #4e73df;
    margin-bottom: 5px;
  }
  
  .stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    font-weight: 600;
  }
  
  .history-content {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  
  .map-section {
    flex: 2;
    min-width: 400px;
  }
  
  .data-section {
    flex: 1;
    min-width: 350px;
  }
  
  .section-card {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }
  
  .section-header {
    background: #f8f9fc;
    padding: 15px 20px;
    border-bottom: 1px solid #e3e6f0;
    font-weight: 600;
    color: #5a5c69;
  }
  
  .section-body {
    padding: 20px;
  }
  
  .map-container {
    height: 400px;
    background-color: #f8f9fc;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
  }
  
  .stops-list {
    max-height: 300px;
    overflow-y: auto;
  }
  
  .stop-item {
    border-bottom: 1px solid #e3e6f0;
    padding: 15px 0;
  }
  
  .stop-item:last-child {
    border-bottom: none;
  }
  
  .stop-time {
    font-weight: 600;
    color: #5a5c69;
    margin-bottom: 5px;
  }
  
  .stop-duration {
    color: #4e73df;
    font-size: 0.9rem;
    margin-bottom: 3px;
  }
  
  .stop-address {
    color: #6c757d;
    font-size: 0.8rem;
  }
  
  .history-table {
    max-height: 400px;
    overflow-y: auto;
  }
  
  .table {
    margin: 0;
  }
  
  .table th {
    background-color: #f8f9fc;
    border-top: none;
    font-weight: 600;
    color: #5a5c69;
    font-size: 0.8rem;
    padding: 10px 8px;
  }
  
  .table td {
    font-size: 0.8rem;
    padding: 8px;
    border-top: 1px solid #e3e6f0;
  }
  
  .speed-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 5px;
  }
  
  .speed-stopped { background-color: #dc3545; }
  .speed-slow { background-color: #ffc107; }
  .speed-normal { background-color: #28a745; }
  .speed-fast { background-color: #fd7e14; }
  
  .btn {
    padding: 8px 16px;
    border-radius: 5px;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
    cursor: pointer;
    border: none;
    font-size: 0.9rem;
  }
  
  .btn-primary {
    background: #4e73df;
    color: white;
  }
  
  .btn-primary:hover {
    background: #2e59d9;
    color: white;
  }
  
  .btn-secondary {
    background: #858796;
    color: white;
  }
  
  .btn-secondary:hover {
    background: #717384;
    color: white;
  }
  
  .btn-outline-secondary {
    background: transparent;
    color: #858796;
    border: 1px solid #858796;
  }
  
  .btn-outline-secondary:hover {
    background: #858796;
    color: white;
  }
  
  .alert {
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
  }
  
  .alert-info {
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
  }
  
  .alert-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
  }
  
  @media (max-width: 768px) {
    .history-content {
      flex-direction: column;
    }
    
    .filter-form {
      flex-direction: column;
    }
    
    .stats-row {
      flex-direction: column;
    }
    
    .form-group {
      min-width: auto;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="history-container">
  <!-- Vehicle Info -->
  <div class="vehicle-info-card">
    <div class="vehicle-header">
      <h1>
        <i class="fas fa-history"></i>
        Tracking History: {{ vehicle.license_plate }}
      </h1>
    </div>
    <div class="vehicle-details">
      <div class="detail-item">
        <span class="detail-label">Make & Model:</span>
        <span class="detail-value">{{ vehicle.make }} {{ vehicle.model }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Year:</span>
        <span class="detail-value">{{ vehicle.year|default:"N/A" }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Device:</span>
        <span class="detail-value">{{ device.name|default:device.device_id }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Period:</span>
        <span class="detail-value">{{ start_time|date:"M j, Y H:i" }} - {{ end_time|date:"M j, Y H:i" }}</span>
      </div>
    </div>
  </div>
  
  <!-- Date Filter -->
  <div class="date-filter-card">
    <div class="filter-title">
      <i class="fas fa-calendar-alt"></i> Select Date Range
    </div>
    <form method="get" class="filter-form">
      <div class="form-group">
        <label for="start_date">Start Date</label>
        <input type="date" 
               name="start_date" 
               id="start_date"
               class="form-control" 
               value="{{ start_date }}"
               max="{{ end_date }}">
      </div>
      <div class="form-group">
        <label for="end_date">End Date</label>
        <input type="date" 
               name="end_date" 
               id="end_date"
               class="form-control" 
               value="{{ end_date }}"
               min="{{ start_date }}"
               max="{% now 'Y-m-d' %}">
      </div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-search"></i> Update History
        </button>
      </div>
    </form>
  </div>
  
  <!-- Statistics -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-value">{{ history_count }}</div>
      <div class="stat-label">Location Records</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ max_speed|floatformat:0 }}</div>
      <div class="stat-label">Max Speed (km/h)</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ avg_speed|floatformat:1 }}</div>
      <div class="stat-label">Avg Speed (km/h)</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stops|length }}</div>
      <div class="stat-label">Stops Detected</div>
    </div>
  </div>
  
  {% if history_count == 0 %}
    {% if start_time and end_time %}
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i>
        No tracking data found for the selected time period ({{ start_time|date:"M j, Y" }} - {{ end_time|date:"M j, Y" }}).
        Try selecting a different date range or check if the device was active during this period.
      </div>
    {% else %}
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        No historical tracking data available for this vehicle yet. 
        Data will appear here once the vehicle starts moving and transmitting location information.
      </div>
    {% endif %}
  {% else %}
    <!-- Main Content -->
    <div class="history-content">
      <!-- Map Section -->
      <div class="map-section">
        <div class="section-card">
          <div class="section-header">
            <i class="fas fa-map-marked-alt"></i> Route Map
          </div>
          <div class="section-body">
            <div class="map-container">
              <div>
                <i class="fas fa-map fa-3x" style="color: #d1d3e2;"></i>
                <p style="margin-top: 10px;">Interactive route map will be displayed here</p>
                <p style="font-size: 0.8rem; color: #858796;">Showing {{ history_count }} location points</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Data Section -->
      <div class="data-section">
        <!-- Stops -->
        {% if stops %}
        <div class="section-card">
          <div class="section-header">
            <i class="fas fa-pause-circle"></i> Stops ({{ stops|length }})
          </div>
          <div class="section-body">
            <div class="stops-list">
              {% for stop in stops %}
                <div class="stop-item">
                  <div class="stop-time">
                    {{ stop.start_time|date:"M j, H:i" }} - {{ stop.end_time|date:"H:i" }}
                  </div>
                  <div class="stop-duration">
                    Duration: 
                    {% with hours=stop.duration.seconds|floatformat:0|add:"0"|div:"3600"|floatformat:0 minutes=stop.duration.seconds|floatformat:0|add:"0"|div:"60"|floatformat:0|add:"0"|mod:"60" %}
                      {% if hours > 0 %}{{ hours }}h {% endif %}{{ minutes }}m
                    {% endwith %}
                  </div>
                  <div class="stop-address">{{ stop.address|truncatechars:50 }}</div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Recent History Table -->
        <div class="section-card">
          <div class="section-header">
            <i class="fas fa-list"></i> Location History (Latest 50)
          </div>
          <div class="section-body">
            <div class="history-table">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Speed</th>
                    <th>Location</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for record in history|slice:":50" %}
                    <tr>
                      <td>{{ record.device_time|date:"M j H:i" }}</td>
                      <td>
                        {% with speed=record.speed|default:0|floatformat:0|add:0 %}
                          {% if speed == 0 %}
                            <span class="speed-indicator speed-stopped"></span>0
                          {% elif speed < 20 %}
                            <span class="speed-indicator speed-slow"></span>{{ speed }}
                          {% elif speed < 60 %}
                            <span class="speed-indicator speed-normal"></span>{{ speed }}
                          {% else %}
                            <span class="speed-indicator speed-fast"></span>{{ speed }}
                          {% endif %}
                          km/h
                        {% endwith %}
                      </td>
                      <td title="{{ record.latitude }}, {{ record.longitude }}">
                        {{ record.address|truncatechars:30|default:"Unknown" }}
                      </td>
                      <td>
                        {% if record.ignition %}
                          <i class="fas fa-key text-success" title="Ignition On"></i>
                        {% else %}
                          <i class="fas fa-key text-muted" title="Ignition Off"></i>
                        {% endif %}
                        {% if record.valid %}
                          <i class="fas fa-satellite text-success" title="GPS Fix Valid"></i>
                        {% else %}
                          <i class="fas fa-satellite text-warning" title="GPS Fix Invalid"></i>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
  
  <!-- Action Buttons -->
  <div style="margin-top: 20px; text-align: center;">
    <a href="{% url 'vehicle_tracking_detail' vehicle.id %}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Back to Live Tracking
    </a>
    <a href="{% url 'tracking_dashboard' %}" class="btn btn-outline-secondary">
      <i class="fas fa-tachometer-alt"></i> Dashboard
    </a>
    {% if history_count > 0 %}
      <a href="#" onclick="window.print()" class="btn btn-outline-secondary">
        <i class="fas fa-print"></i> Print Report
      </a>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-adjust date inputs
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    startDateInput.addEventListener('change', function() {
        endDateInput.min = this.value;
        if (endDateInput.value < this.value) {
            endDateInput.value = this.value;
        }
    });
    
    endDateInput.addEventListener('change', function() {
        startDateInput.max = this.value;
        if (startDateInput.value > this.value) {
            startDateInput.value = this.value;
        }
    });
    
    // Initialize map if we have history data
    {% if history_count > 0 %}
    // This would initialize the interactive map
    // For now, we'll just show a placeholder
    console.log('History data available for map rendering');
    console.log('Records: {{ history_count }}');
    {% endif %}
});
</script>
{% endblock %}
