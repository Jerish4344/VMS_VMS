{% extends 'base.html' %}

{% block title %}
  {% if action == 'Create' %}Add Fuel Entry{% else %}Edit Fuel Entry{% endif %} | Generator Management
{% endblock %}

{% block extra_css %}
<style>
  .form-card {
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  .form-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
    border-radius: 10px 10px 0 0;
    padding: 15px 20px;
  }
  
  .form-body {
    padding: 20px;
  }
  
  .form-footer {
    background-color: #f8f9fc;
    border-top: 1px solid #e3e6f0;
    border-radius: 0 0 10px 10px;
    padding: 15px 20px;
  }
  
  .required-field::after {
    content: "*";
    color: #e74a3b;
    margin-left: 4px;
  }
  
  .form-control:focus, .form-select:focus {
    border-color: #bac8f3;
    box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
  }
  
  .help-text {
    font-size: 0.85rem;
    color: #858796;
    margin-top: 4px;
  }
  
  .btn-action {
    border-radius: 8px;
    padding: 8px 20px;
    font-weight: 500;
  }
  
  .btn-cancel {
    background-color: #f8f9fc;
    border-color: #d1d3e2;
    color: #6e707e;
  }
  
  .btn-cancel:hover {
    background-color: #eaecf4;
    border-color: #d1d3e2;
    color: #6e707e;
  }
  
  .total-cost-preview {
    background-color: #f8f9fc;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
    border-left: 4px solid #1cc88a;
  }
  
  .total-cost-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1cc88a;
  }
  
  .store-selector {
    margin-bottom: 15px;
  }
  
  .fuel-type-badges {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  
  .fuel-type-badge {
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
  }
  
  .fuel-type-badge:hover {
    transform: translateY(-2px);
  }
  
  .fuel-type-badge.active {
    border-color: #4e73df;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  .diesel-badge {
    background-color: #e8e8e8;
    color: #5a5c69;
  }
  
  .petrol-badge {
    background-color: #e3fcef;
    color: #1cc88a;
  }
  
  .gas-badge {
    background-color: #e3f2fd;
    color: #36b9cc;
  }
  
  .other-badge {
    background-color: #fff3cd;
    color: #f6c23e;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'generators:dashboard' %}">Generator Management</a></li>
      <li class="breadcrumb-item"><a href="{% url 'generators:fuel_entry_list' %}">Fuel Entries</a></li>
      <li class="breadcrumb-item active" aria-current="page">
        {% if action == 'Create' %}Add New Fuel Entry{% else %}Edit Fuel Entry{% endif %}
      </li>
    </ol>
  </nav>

  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0 text-gray-800">
        {% if action == 'Create' %}Add Fuel Entry{% else %}Edit Fuel Entry{% endif %}
      </h1>
      <p class="mb-0 text-muted">
        {% if action == 'Create' %}
          Record fuel consumption for generators
        {% else %}
          Update fuel entry details for {{ form.instance.date_of_filling }}
        {% endif %}
      </p>
    </div>
  </div>

  <!-- Form Card -->
  <div class="card shadow form-card mb-4">
    <div class="form-header">
      <h5 class="m-0 font-weight-bold text-success">
        <i class="fas fa-gas-pump me-2"></i>
        {% if action == 'Create' %}Fuel Entry Details{% else %}Edit Fuel Entry{% endif %}
      </h5>
    </div>
    
    <div class="form-body">
      <form method="post" novalidate id="fuelEntryForm">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
              {{ error }}
            {% endfor %}
          </div>
        {% endif %}
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="{{ form.date_of_filling.id_for_label }}" class="form-label required-field">Date of Filling</label>
            {{ form.date_of_filling }}
            {% if form.date_of_filling.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.date_of_filling.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
            {% if form.date_of_filling.help_text %}
              <div class="help-text">{{ form.date_of_filling.help_text }}</div>
            {% endif %}
          </div>
          
          <div class="col-md-6">
            <label for="{{ form.store.id_for_label }}" class="form-label required-field">Store</label>
            {{ form.store }}
            {% if form.store.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.store.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
            {% if form.store.help_text %}
              <div class="help-text">{{ form.store.help_text }}</div>
            {% endif %}
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="{{ form.generator.id_for_label }}" class="form-label required-field">Generator</label>
            {{ form.generator }}
            {% if form.generator.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.generator.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
            <div class="help-text">
              <i class="fas fa-info-circle me-1"></i>
              Generators are filtered based on selected store
            </div>
          </div>
          
          <div class="col-md-6">
            <label for="{{ form.fuel_type.id_for_label }}" class="form-label required-field">Fuel Type</label>
            {{ form.fuel_type }}
            {% if form.fuel_type.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.fuel_type.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
            
            <div class="fuel-type-badges">
              <div class="fuel-type-badge diesel-badge" data-value="diesel">
                <i class="fas fa-gas-pump me-1"></i>Diesel
              </div>
              <div class="fuel-type-badge petrol-badge" data-value="petrol">
                <i class="fas fa-gas-pump me-1"></i>Petrol
              </div>
              <div class="fuel-type-badge gas-badge" data-value="gas">
                <i class="fas fa-gas-pump me-1"></i>Gas
              </div>
              <div class="fuel-type-badge other-badge" data-value="other">
                <i class="fas fa-gas-pump me-1"></i>Other
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="{{ form.litres_filled.id_for_label }}" class="form-label required-field">Litres Filled</label>
            {{ form.litres_filled }}
            {% if form.litres_filled.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.litres_filled.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
            {% if form.litres_filled.help_text %}
              <div class="help-text">{{ form.litres_filled.help_text }}</div>
            {% endif %}
          </div>
          
          <div class="col-md-6">
            <label for="{{ form.fuel_rate_per_litre.id_for_label }}" class="form-label required-field">Rate per Litre (â‚¹)</label>
            {{ form.fuel_rate_per_litre }}
            {% if form.fuel_rate_per_litre.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.fuel_rate_per_litre.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
            {% if form.fuel_rate_per_litre.help_text %}
              <div class="help-text">{{ form.fuel_rate_per_litre.help_text }}</div>
            {% endif %}
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="{{ form.invoice_number.id_for_label }}" class="form-label">Invoice Number</label>
            {{ form.invoice_number }}
            {% if form.invoice_number.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.invoice_number.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
            {% if form.invoice_number.help_text %}
              <div class="help-text">{{ form.invoice_number.help_text }}</div>
            {% endif %}
          </div>
          
          <div class="col-md-6">
            <label for="{{ form.vendor_name.id_for_label }}" class="form-label">Vendor Name</label>
            {{ form.vendor_name }}
            {% if form.vendor_name.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.vendor_name.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
            {% if form.vendor_name.help_text %}
              <div class="help-text">{{ form.vendor_name.help_text }}</div>
            {% endif %}
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="{{ form.filled_by.id_for_label }}" class="form-label">Filled By</label>
            {{ form.filled_by }}
            {% if form.filled_by.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.filled_by.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
            <div class="help-text">
              <i class="fas fa-info-circle me-1"></i>
              Person who filled the fuel (defaults to current user)
            </div>
          </div>
          
          <div class="col-md-6">
            <label for="{{ form.total_cost_preview.id_for_label }}" class="form-label">Total Cost (â‚¹)</label>
            {{ form.total_cost_preview }}
            <div class="help-text">
              <i class="fas fa-calculator me-1"></i>
              Automatically calculated based on litres and rate
            </div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-12">
            <label for="{{ form.comments.id_for_label }}" class="form-label">Comments</label>
            {{ form.comments }}
            {% if form.comments.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.comments.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
            {% if form.comments.help_text %}
              <div class="help-text">{{ form.comments.help_text }}</div>
            {% endif %}
          </div>
        </div>
        
        <div class="total-cost-preview">
          <div class="row">
            <div class="col-md-6">
              <h6>Total Fuel Cost:</h6>
              <div class="total-cost-value" id="totalCostDisplay">
                {% if form.instance.total_fuel_cost %}
                  â‚¹ {{ form.instance.total_fuel_cost|floatformat:2 }}
                {% else %}
                  â‚¹ 0.00
                {% endif %}
              </div>
              <div class="help-text">
                <i class="fas fa-info-circle me-1"></i>
                Total cost will be calculated automatically (Litres Ã— Rate)
              </div>
            </div>
            <div class="col-md-6">
              <div class="alert alert-info mb-0">
                <i class="fas fa-lightbulb me-2"></i>
                <strong>Tip:</strong> You can update the litres or rate to see the total cost change in real-time.
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-footer d-flex justify-content-between">
          <a href="{% url 'generators:fuel_entry_list' %}" class="btn btn-cancel btn-action">
            <i class="fas fa-times me-2"></i>Cancel
          </a>
          <button type="submit" class="btn btn-success btn-action">
            {% if action == 'Create' %}
              <i class="fas fa-plus-circle me-2"></i>Add Fuel Entry
            {% else %}
              <i class="fas fa-save me-2"></i>Update Fuel Entry
            {% endif %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add Bootstrap classes to form elements
    const formControls = document.querySelectorAll('input, select, textarea');
    formControls.forEach(element => {
      if (!element.classList.contains('form-check-input')) {
        if (element.tagName.toLowerCase() === 'select') {
          element.classList.add('form-select');
        } else if (element.tagName.toLowerCase() === 'textarea') {
          element.classList.add('form-control');
          element.rows = 3;
        } else {
          element.classList.add('form-control');
        }
      }
    });
    
    // Focus on first field
    const firstInput = document.querySelector('form input[type="date"], form select:first-of-type');
    if (firstInput) {
      firstInput.focus();
    }
    
    // Pre-select store and generator if provided in URL
    const urlParams = new URLSearchParams(window.location.search);
    const storeId = urlParams.get('store');
    const generatorId = urlParams.get('generator');
    
    if (storeId) {
      const storeSelect = document.getElementById('id_store');
      if (storeSelect) {
        storeSelect.value = storeId;
        // Trigger change event to update generators dropdown
        const event = new Event('change');
        storeSelect.dispatchEvent(event);
      }
    }
    
    if (generatorId) {
      const generatorSelect = document.getElementById('id_generator');
      if (generatorSelect) {
        // We need to wait a bit if store was also selected to ensure generators are loaded
        setTimeout(() => {
          generatorSelect.value = generatorId;
        }, 300);
      }
    }
    
    // Store change handler to filter generators
    const storeSelect = document.getElementById('id_store');
    const generatorSelect = document.getElementById('id_generator');
    
    if (storeSelect && generatorSelect) {
      storeSelect.addEventListener('change', function() {
        const storeId = this.value;
        
        if (!storeId) {
          return;
        }
        
        // Save current selection
        const currentSelection = generatorSelect.value;
        
        // Show loading indicator
        generatorSelect.disabled = true;
        generatorSelect.innerHTML = '<option value="">Loading generators...</option>';
        
        // Fetch generators for the selected store
        fetch(`/generators/api/generators-by-store/${storeId}/`)
          .then(response => response.json())
          .then(data => {
            generatorSelect.innerHTML = '<option value="">Select Generator</option>';
            
            data.forEach(generator => {
              const option = document.createElement('option');
              option.value = generator.id;
              option.textContent = generator.make_and_model;
              generatorSelect.appendChild(option);
            });
            
            // Try to restore previous selection if it exists in new options
            if (currentSelection) {
              const exists = Array.from(generatorSelect.options).some(opt => opt.value === currentSelection);
              if (exists) {
                generatorSelect.value = currentSelection;
              }
            }
            
            generatorSelect.disabled = false;
          })
          .catch(error => {
            console.error('Error fetching generators:', error);
            generatorSelect.innerHTML = '<option value="">Error loading generators</option>';
            generatorSelect.disabled = false;
          });
      });
    }
    
    // Calculate total cost when litres or rate changes
    const litresInput = document.getElementById('id_litres_filled');
    const rateInput = document.getElementById('id_fuel_rate_per_litre');
    const totalCostDisplay = document.getElementById('totalCostDisplay');
    const totalCostPreview = document.getElementById('id_total_cost_preview');
    
    function calculateTotalCost() {
      if (litresInput.value && rateInput.value) {
        const litres = parseFloat(litresInput.value);
        const rate = parseFloat(rateInput.value);
        
        if (!isNaN(litres) && !isNaN(rate)) {
          const totalCost = litres * rate;
          totalCostDisplay.textContent = `â‚¹ ${totalCost.toFixed(2)}`;
          if (totalCostPreview) {
            totalCostPreview.value = totalCost.toFixed(2);
          }
        }
      }
    }
    
    if (litresInput && rateInput && totalCostDisplay) {
      litresInput.addEventListener('input', calculateTotalCost);
      rateInput.addEventListener('input', calculateTotalCost);
      
      // Calculate on page load if values exist
      calculateTotalCost();
    }
    
    // Fuel type badge selection
    const fuelTypeSelect = document.getElementById('id_fuel_type');
    const fuelTypeBadges = document.querySelectorAll('.fuel-type-badge');
    
    if (fuelTypeSelect && fuelTypeBadges.length) {
      // Set initial active state
      const currentValue = fuelTypeSelect.value;
      fuelTypeBadges.forEach(badge => {
        if (badge.dataset.value === currentValue) {
          badge.classList.add('active');
        }
      });
      
      // Add click handlers
      fuelTypeBadges.forEach(badge => {
        badge.addEventListener('click', function() {
          const value = this.dataset.value;
          
          // Update select value
          fuelTypeSelect.value = value;
          
          // Update active state
          fuelTypeBadges.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
        });
      });
    }
  });
</script>
{{ form.js_functions|safe }}
{% endblock %}
