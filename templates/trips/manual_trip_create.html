{% extends 'base.html' %}
{% load static %}

{% block title %}Manual Trip Entry - Vehicle Management System{% endblock %}

{% block extra_css %}
<style>
  .form-section {
    background-color: #f8f9fc;
    border: 1px solid #e3e6f0;
    border-radius: 0.375rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .form-section-title {
    font-weight: 700;
    color: #5a5c69;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #4e73df;
  }
  
  .required-label::after {
    content: " *";
    color: #e74a3b;
  }
  
  .vehicle-preview, .driver-preview {
    background-color: #e7f1ff;
    border: 1px solid #b8daff;
    border-radius: 0.25rem;
    padding: 1rem;
    margin-top: 0.5rem;
    display: none;
  }
  
  .preview-info {
    margin-bottom: 0.5rem;
  }
  
  .preview-info strong {
    color: #495057;
  }
  
  .odometer-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 0.75rem;
    border-radius: 0.25rem;
    margin-top: 0.5rem;
    font-size: 0.875rem;
  }
  
  .route-display {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 1rem 0;
    padding: 1rem;
    background-color: #f8f9fc;
    border-radius: 0.25rem;
    border-left: 4px solid #4e73df;
  }
  
  .location-point {
    flex: 1;
    text-align: center;
  }
  
  .route-arrow {
    font-size: 1.5rem;
    color: #4e73df;
  }
  
  .quick-fill-buttons {
    margin-bottom: 1rem;
  }
  
  .quick-fill-buttons .btn {
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .manual-entry-header {
    background: linear-gradient(135deg, #4e73df, #36b9cc);
    color: white;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
    text-align: center;
  }
  
  /* Searchable Dropdown Styles */
  .search-wrapper {
    position: relative;
  }

  .search-input {
    width: 100%;
    padding: 0.75rem 2.5rem 0.75rem 0.75rem;
    border: 1px solid #d1d3e2;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    background-color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .search-input:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    outline: none;
    cursor: text;
  }

  .search-input.has-value {
    color: #5a5c69;
    font-weight: 500;
  }

  .search-icon {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #858796;
    pointer-events: none;
    transition: all 0.2s ease;
  }

  .search-clear {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #858796;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 50%;
    display: none;
    transition: all 0.2s ease;
  }

  .search-clear:hover {
    color: #e74a3b;
    background-color: #f8f9fc;
  }

  .dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1050;
    background: white;
    border: 1px solid #e3e6f0;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    max-height: 400px;
    display: none;
    margin-top: 0.25rem;
    overflow: hidden;
  }

  .dropdown.show {
    display: block;
    animation: dropdownFadeIn 0.2s ease-out;
  }

  @keyframes dropdownFadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .dropdown-header {
    padding: 0.75rem 1rem;
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
    font-size: 0.875rem;
    font-weight: 600;
    color: #5a5c69;
  }

  .dropdown-list {
    max-height: 320px;
    overflow-y: auto;
  }

  .dropdown-item {
    padding: 1rem;
    border-bottom: 1px solid #f1f1f1;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .dropdown-item:hover {
    background-color: #f8f9fc;
  }

  .dropdown-item:last-child {
    border-bottom: none;
  }

  .dropdown-item.selected {
    background-color: #e3f2fd;
    border-left: 4px solid #4e73df;
  }

  .dropdown-item.focused {
    background-color: #f0f8ff;
    outline: 2px solid #4e73df;
    outline-offset: -2px;
  }

  .item-image {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 0.375rem;
    border: 1px solid #e3e6f0;
  }

  .item-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fc;
    border: 1px solid #e3e6f0;
    border-radius: 0.375rem;
    color: #858796;
    font-size: 1.25rem;
  }

  .item-details {
    flex: 1;
    min-width: 0;
  }

  .item-details h6 {
    margin: 0 0 0.25rem 0;
    font-weight: 600;
    color: #5a5c69;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .item-details .text-muted {
    font-size: 0.75rem;
    margin: 0;
    color: #858796;
  }

  .item-badges {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.25rem;
    flex-shrink: 0;
  }

  .item-badges .badge {
    font-size: 0.65rem;
    padding: 0.25rem 0.5rem;
    white-space: nowrap;
  }

  .no-items-found {
    text-align: center;
    padding: 2rem 1rem;
    color: #858796;
  }

  .no-items-found i {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: #d1d3e2;
  }

  .no-items-found h6 {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #5a5c69;
  }

  .no-items-found p {
    margin: 0;
    font-size: 0.875rem;
  }

  /* Custom scrollbar for dropdown */
  .dropdown-list::-webkit-scrollbar {
    width: 6px;
  }

  .dropdown-list::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  .dropdown-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
  }

  .dropdown-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }

  /* Loading state */
  .dropdown-loading {
    padding: 2rem 1rem;
    text-align: center;
    color: #858796;
  }

  .dropdown-loading i {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Page Header -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'manual_trip_list' %}">Manual Trips</a></li>
          <li class="breadcrumb-item active">Add New Trip</li>
        </ol>
      </nav>
      <h1 class="h3 mb-0 text-gray-800">Manual Trip Entry</h1>
      <p class="text-muted">Add trip data for drivers without mobile access</p>
    </div>
    <div>
      <a href="{% url 'manual_trip_list' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i>Back to List
      </a>
    </div>
  </div>

  <!-- Manual Entry Header -->
  <div class="manual-entry-header">
    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
    <h4 class="mb-1">Manual Trip Entry Mode</h4>
    <p class="mb-0 opacity-75">Fill in the trip details for drivers without mobile access</p>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-10">
      <form method="post" id="manualTripForm">
        {% csrf_token %}
        
        <!-- Form Errors -->
        {% if form.errors %}
        <div class="alert alert-danger">
          <h5>Please correct the following errors:</h5>
          {% for field, errors in form.errors.items %}
            <p><strong>{{ field }}:</strong> {{ errors|join:", " }}</p>
          {% endfor %}
        </div>
        {% endif %}
        
        <!-- Driver & Vehicle Selection -->
        <div class="form-section">
          <h5 class="form-section-title">
            <i class="fas fa-users me-2"></i>Driver & Vehicle Selection
          </h5>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="driverSearchInput" class="form-label required-label">Driver</label>
              <div class="search-wrapper">
                <input 
                  type="text" 
                  class="search-input" 
                  id="driverSearchInput" 
                  placeholder="Click to select or type to search drivers..."
                  autocomplete="off"
                  readonly
                >
                <i class="fas fa-chevron-down search-icon" id="driverSearchIcon"></i>
                <button type="button" class="search-clear" id="driverSearchClear">
                  <i class="fas fa-times"></i>
                </button>
                
                <!-- Hidden form field -->
                <input type="hidden" name="driver" id="{{ form.driver.id_for_label }}" value="">
                
                <!-- Custom dropdown -->
                <div class="dropdown" id="driverDropdown">
                  <div class="dropdown-header">
                    <span id="driverDropdownHeader">Available Drivers</span>
                  </div>
                  <div class="dropdown-list" id="driverDropdownList">
                    <!-- Populated by JavaScript -->
                  </div>
                </div>
              </div>
              <div class="driver-preview" id="driverPreview">
                <div class="preview-info">
                  <strong>Full Name:</strong> <span id="driverFullName"></span>
                </div>
                <div class="preview-info">
                  <strong>Email:</strong> <span id="driverEmail"></span>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="vehicleSearchInput" class="form-label required-label">Vehicle</label>
              <div class="search-wrapper">
                <input 
                  type="text" 
                  class="search-input" 
                  id="vehicleSearchInput" 
                  placeholder="Click to select or type to search vehicles..."
                  autocomplete="off"
                  readonly
                >
                <i class="fas fa-chevron-down search-icon" id="vehicleSearchIcon"></i>
                <button type="button" class="search-clear" id="vehicleSearchClear">
                  <i class="fas fa-times"></i>
                </button>
                
                <!-- Hidden form field -->
                <input type="hidden" name="vehicle" id="{{ form.vehicle.id_for_label }}" value="">
                
                <!-- Custom dropdown -->
                <div class="dropdown" id="vehicleDropdown">
                  <div class="dropdown-header">
                    <span id="vehicleDropdownHeader">Available Vehicles</span>
                  </div>
                  <div class="dropdown-list" id="vehicleDropdownList">
                    <!-- Populated by JavaScript -->
                  </div>
                </div>
              </div>
              <div class="vehicle-preview" id="vehiclePreview">
                <div class="preview-info">
                  <strong>License Plate:</strong> <span id="vehicleLicensePlate"></span>
                </div>
                <div class="preview-info">
                  <strong>Make & Model:</strong> <span id="vehicleMakeModel"></span>
                </div>
                <div class="preview-info">
                  <strong>Current Odometer:</strong> <span id="vehicleOdometer"></span> km
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Route Information -->
        <div class="form-section">
          <h5 class="form-section-title">
            <i class="fas fa-route me-2"></i>Route Information
          </h5>
          
          <!-- Quick Fill Buttons -->
          <div class="quick-fill-buttons">
            <small class="text-muted">Quick locations:</small><br>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-location="Main Office">
              <i class="fas fa-building me-1"></i>Main Office
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-location="Warehouse">
              <i class="fas fa-warehouse me-1"></i>Warehouse
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-location="Airport">
              <i class="fas fa-plane me-1"></i>Airport
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-location="City Center">
              <i class="fas fa-city me-1"></i>City Center
            </button>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="id_origin" class="form-label required-label">
                <i class="fas fa-map-marker-alt text-success me-1"></i>Origin (From)
              </label>
              <input type="text" class="form-control" id="id_origin" name="origin" 
                     placeholder="Starting location" required>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="id_destination" class="form-label required-label">
                <i class="fas fa-map-marker-alt text-danger me-1"></i>Destination (To)
              </label>
              <input type="text" class="form-control" id="id_destination" name="destination" 
                     placeholder="Destination location" required>
            </div>
          </div>
          
          <!-- Route Preview -->
          <div class="route-display" id="routeDisplay" style="display: none;">
            <div class="location-point">
              <i class="fas fa-map-marker-alt text-success fa-lg"></i>
              <div class="mt-1">
                <strong id="previewOrigin">Origin</strong>
              </div>
            </div>
            <div class="route-arrow">
              <i class="fas fa-arrow-right"></i>
            </div>
            <div class="location-point">
              <i class="fas fa-map-marker-alt text-danger fa-lg"></i>
              <div class="mt-1">
                <strong id="previewDestination">Destination</strong>
              </div>
            </div>
          </div>
        </div>

        <!-- Trip Timing -->
        <div class="form-section">
          <h5 class="form-section-title">
            <i class="fas fa-clock me-2"></i>Trip Timing
          </h5>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="id_start_time" class="form-label required-label">Start Date & Time</label>
              <input type="datetime-local" class="form-control" id="id_start_time" 
                     name="start_time" required>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="id_end_time" class="form-label">End Date & Time</label>
              <input type="datetime-local" class="form-control" id="id_end_time" name="end_time">
              <div class="form-text">Leave empty if trip is still ongoing</div>
            </div>
          </div>
          
          <!-- Quick Time Buttons -->
          <div class="quick-fill-buttons">
            <small class="text-muted">Quick fill start time:</small><br>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setTimeToMorning('start')">
              <i class="fas fa-sun me-1"></i>8:00 AM Today
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setTimeToYesterday('start')">
              <i class="fas fa-calendar-minus me-1"></i>Yesterday 8:00 AM
            </button>
          </div>
        </div>

        <!-- Odometer Readings -->
        <div class="form-section">
          <h5 class="form-section-title">
            <i class="fas fa-tachometer-alt me-2"></i>Odometer Readings
          </h5>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="id_start_odometer" class="form-label required-label">Start Odometer (km)</label>
              <input type="number" class="form-control" id="id_start_odometer" 
                     name="start_odometer" min="0" required>
              <div class="form-text">Odometer reading at trip start</div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="id_end_odometer" class="form-label">End Odometer (km)</label>
              <input type="number" class="form-control" id="id_end_odometer" 
                     name="end_odometer" min="0">
              <div class="form-text">Leave empty if trip is ongoing</div>
            </div>
          </div>
          
          <div id="odometerWarning" class="odometer-warning" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="odometerWarningText"></span>
          </div>
          
          <div id="distanceCalculation" class="mt-2 text-info" style="display: none;">
            <i class="fas fa-route me-1"></i>
            <strong>Distance Traveled: <span id="calculatedDistance">0</span> km</strong>
          </div>
        </div>

        <!-- Trip Details -->
        <div class="form-section">
          <h5 class="form-section-title">
            <i class="fas fa-clipboard me-2"></i>Trip Details
          </h5>
          
          <div class="mb-3">
            <label for="id_purpose" class="form-label required-label">Purpose of Trip</label>
            <input type="text" class="form-control" id="id_purpose" name="purpose" 
                   placeholder="e.g., Client Meeting, Delivery, Maintenance" required>
          </div>
          
          <div class="mb-3">
            <label for="id_notes" class="form-label">Additional Notes</label>
            <textarea class="form-control" id="id_notes" name="notes" rows="3"
                      placeholder="Any additional details about the trip..."></textarea>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-section">
          <div class="d-flex justify-content-between">
            <div>
              <button type="button" class="btn btn-secondary me-2" onclick="resetForm()">
                <i class="fas fa-undo me-1"></i>Reset Form
              </button>
              <button type="button" class="btn btn-outline-info" onclick="loadSampleData()">
                <i class="fas fa-magic me-1"></i>Load Sample Data
              </button>
            </div>
            <div>
              <button type="button" class="btn btn-info me-2" onclick="previewTrip()">
                <i class="fas fa-eye me-1"></i>Preview
              </button>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-1"></i>Save Trip
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Trip Preview Modal -->
<div class="modal fade" id="tripPreviewModal" tabindex="-1" aria-labelledby="tripPreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tripPreviewModalLabel">Trip Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="tripPreviewContent">
          <!-- Populated by JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-success" onclick="document.getElementById('manualTripForm').submit();">
          <i class="fas fa-save me-1"></i>Save Trip
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Form elements
    const originInput = document.getElementById('id_origin');
    const destinationInput = document.getElementById('id_destination');
    const startTimeInput = document.getElementById('id_start_time');
    const endTimeInput = document.getElementById('id_end_time');
    const startOdometerInput = document.getElementById('id_start_odometer');
    const endOdometerInput = document.getElementById('id_end_odometer');
    
    // Preview elements
    const driverPreview = document.getElementById('driverPreview');
    const vehiclePreview = document.getElementById('vehiclePreview');
    const routeDisplay = document.getElementById('routeDisplay');
    const odometerWarning = document.getElementById('odometerWarning');
    const distanceCalculation = document.getElementById('distanceCalculation');
    
    // Driver search elements
    const driverSearchInput = document.getElementById('driverSearchInput');
    const driverSearchIcon = document.getElementById('driverSearchIcon');
    const driverSearchClear = document.getElementById('driverSearchClear');
    const driverDropdown = document.getElementById('driverDropdown');
    const driverDropdownList = document.getElementById('driverDropdownList');
    const driverDropdownHeader = document.getElementById('driverDropdownHeader');
    const hiddenDriverField = document.getElementById('{{ form.driver.id_for_label }}');
    
    // Vehicle search elements
    const vehicleSearchInput = document.getElementById('vehicleSearchInput');
    const vehicleSearchIcon = document.getElementById('vehicleSearchIcon');
    const vehicleSearchClear = document.getElementById('vehicleSearchClear');
    const vehicleDropdown = document.getElementById('vehicleDropdown');
    const vehicleDropdownList = document.getElementById('vehicleDropdownList');
    const vehicleDropdownHeader = document.getElementById('vehicleDropdownHeader');
    const hiddenVehicleField = document.getElementById('{{ form.vehicle.id_for_label }}');
    
    // Driver data and state
    let allDrivers = [];
    let filteredDrivers = [];
    let selectedDriver = null;
    let driverFocusedIndex = -1;
    let isDriverDropdownOpen = false;
    
    // Vehicle data and state
    let allVehicles = [];
    let filteredVehicles = [];
    let selectedVehicle = null;
    let vehicleFocusedIndex = -1;
    let isVehicleDropdownOpen = false;
    let selectedVehicleOdometer = 0;
    
    // Build drivers data array
    {% for driver in form.driver.field.queryset %}
    allDrivers.push({
      id: '{{ driver.id }}',
      name: '{{ driver.get_full_name|default:driver.username }}',
      email: '{{ driver.email }}',
      username: '{{ driver.username }}',
      searchText: '{{ driver.get_full_name|default:driver.username }} {{ driver.email }} {{ driver.username }}'.toLowerCase()
    });
    {% endfor %}
    
    filteredDrivers = [...allDrivers];
    
    // Build vehicles data array
    {% for vehicle in form.vehicle.field.queryset %}
    allVehicles.push({
      id: '{{ vehicle.id }}',
      make: '{{ vehicle.make }}',
      model: '{{ vehicle.model }}',
      plate: '{{ vehicle.license_plate }}',
      type: '{{ vehicle.vehicle_type.name|default:"Unknown" }}',
      fuel: '{{ vehicle.fuel_type|default:"Unknown" }}',
      odometer: '{{ vehicle.current_odometer|default:"0" }}',
      image: '{% if vehicle.image %}{{ vehicle.image.url }}{% endif %}',
      searchText: '{{ vehicle.make }} {{ vehicle.model }} {{ vehicle.license_plate }} {{ vehicle.vehicle_type.name|default:"" }}'.toLowerCase()
    });
    {% endfor %}
    
    filteredVehicles = [...allVehicles];
    
    // Render driver dropdown items
    function renderDriverDropdown() {
      driverDropdownList.innerHTML = '';
      
      if (filteredDrivers.length === 0) {
        driverDropdownList.innerHTML = `
          <div class="no-items-found">
            <i class="fas fa-user-slash"></i>
            <h6>No Drivers Found</h6>
            <p>No drivers match your search criteria.</p>
          </div>
        `;
        return;
      }
      
      filteredDrivers.forEach((driver, index) => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.dataset.driverId = driver.id;
        item.dataset.index = index;
        
        if (selectedDriver && selectedDriver.id === driver.id) {
          item.classList.add('selected');
        }
        
        item.innerHTML = `
          <div class="item-icon"><i class="fas fa-user"></i></div>
          <div class="item-details">
            <h6>${driver.name}</h6>
            <div class="text-muted">${driver.email}</div>
          </div>
        `;
        
        item.addEventListener('click', () => selectDriver(driver));
        driverDropdownList.appendChild(item);
      });
    }
    
    // Render vehicle dropdown items
    function renderVehicleDropdown() {
      vehicleDropdownList.innerHTML = '';
      
      if (filteredVehicles.length === 0) {
        vehicleDropdownList.innerHTML = `
          <div class="no-items-found">
            <i class="fas fa-car-side"></i>
            <h6>No Vehicles Found</h6>
            <p>No vehicles match your search criteria.</p>
          </div>
        `;
        return;
      }
      
      filteredVehicles.forEach((vehicle, index) => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.dataset.vehicleId = vehicle.id;
        item.dataset.index = index;
        
        if (selectedVehicle && selectedVehicle.id === vehicle.id) {
          item.classList.add('selected');
        }
        
        item.innerHTML = `
          ${vehicle.image ? 
            `<img src="${vehicle.image}" class="item-image" alt="${vehicle.plate}">` :
            '<div class="item-icon"><i class="fas fa-car"></i></div>'
          }
          <div class="item-details">
            <h6>${vehicle.make} ${vehicle.model}</h6>
            <div class="text-muted">${vehicle.plate} â€¢ ${vehicle.type}</div>
          </div>
          <div class="item-badges">
            <span class="badge bg-primary">${vehicle.fuel}</span>
            <span class="badge bg-secondary">${vehicle.odometer} km</span>
          </div>
        `;
        
        item.addEventListener('click', () => selectVehicle(vehicle));
        vehicleDropdownList.appendChild(item);
      });
    }
    
    // Select driver
    function selectDriver(driver) {
      selectedDriver = driver;
      hiddenDriverField.value = driver.id;
      
      // Update input display
      driverSearchInput.value = driver.name;
      driverSearchInput.classList.add('has-value');
      
      // Update preview
      document.getElementById('driverFullName').textContent = driver.name;
      document.getElementById('driverEmail').textContent = driver.email;
      driverPreview.style.display = 'block';
      
      // Show clear button, hide dropdown
      driverSearchClear.style.display = 'block';
      driverSearchIcon.style.display = 'none';
      closeDriverDropdown();
      
      // Make input readonly
      driverSearchInput.setAttribute('readonly', true);
    }
    
    // Select vehicle
    function selectVehicle(vehicle) {
      selectedVehicle = vehicle;
      hiddenVehicleField.value = vehicle.id;
      
      // Update input display
      vehicleSearchInput.value = `${vehicle.make} ${vehicle.model} (${vehicle.plate})`;
      vehicleSearchInput.classList.add('has-value');
      
      // Update preview
      document.getElementById('vehicleLicensePlate').textContent = vehicle.plate;
      document.getElementById('vehicleMakeModel').textContent = `${vehicle.make} ${vehicle.model}`;
      document.getElementById('vehicleOdometer').textContent = vehicle.odometer;
      
      // Update odometer
      selectedVehicleOdometer = parseInt(vehicle.odometer);
      startOdometerInput.min = selectedVehicleOdometer;
      startOdometerInput.value = selectedVehicleOdometer;
      
      vehiclePreview.style.display = 'block';
      validateOdometer();
      
      // Show clear button, hide dropdown
      vehicleSearchClear.style.display = 'block';
      vehicleSearchIcon.style.display = 'none';
      closeVehicleDropdown();
      
      // Make input readonly
      vehicleSearchInput.setAttribute('readonly', true);
    }
    
    // Clear driver selection
    function clearDriverSelection() {
      selectedDriver = null;
      hiddenDriverField.value = '';
      driverSearchInput.value = '';
      driverSearchInput.classList.remove('has-value');
      driverSearchInput.removeAttribute('readonly');
      
      driverSearchClear.style.display = 'none';
      driverSearchIcon.style.display = 'block';
      
      driverPreview.style.display = 'none';
      renderDriverDropdown();
    }
    
    // Clear vehicle selection
    function clearVehicleSelection() {
      selectedVehicle = null;
      hiddenVehicleField.value = '';
      vehicleSearchInput.value = '';
      vehicleSearchInput.classList.remove('has-value');
      vehicleSearchInput.removeAttribute('readonly');
      
      vehicleSearchClear.style.display = 'none';
      vehicleSearchIcon.style.display = 'block';
      
      vehiclePreview.style.display = 'none';
      selectedVehicleOdometer = 0;
      renderVehicleDropdown();
    }
    
    // Open driver dropdown
    function openDriverDropdown() {
      if (isDriverDropdownOpen) return;
      
      isDriverDropdownOpen = true;
      driverDropdown.classList.add('show');
      driverSearchIcon.style.transform = 'translateY(-50%) rotate(180deg)';
      renderDriverDropdown();
      driverFocusedIndex = -1;
    }
    
    // Close driver dropdown
    function closeDriverDropdown() {
      if (!isDriverDropdownOpen) return;
      
      isDriverDropdownOpen = false;
      driverDropdown.classList.remove('show');
      driverSearchIcon.style.transform = 'translateY(-50%) rotate(0deg)';
      driverFocusedIndex = -1;
      
      // Reset input if no selection
      if (!selectedDriver) {
        driverSearchInput.value = '';
        driverSearchInput.setAttribute('readonly', true);
      }
    }
    
    // Open vehicle dropdown
    function openVehicleDropdown() {
      if (isVehicleDropdownOpen) return;
      
      isVehicleDropdownOpen = true;
      vehicleDropdown.classList.add('show');
      vehicleSearchIcon.style.transform = 'translateY(-50%) rotate(180deg)';
      renderVehicleDropdown();
      vehicleFocusedIndex = -1;
    }
    
    // Close vehicle dropdown
    function closeVehicleDropdown() {
      if (!isVehicleDropdownOpen) return;
      
      isVehicleDropdownOpen = false;
      vehicleDropdown.classList.remove('show');
      vehicleSearchIcon.style.transform = 'translateY(-50%) rotate(0deg)';
      vehicleFocusedIndex = -1;
      
      // Reset input if no selection
      if (!selectedVehicle) {
        vehicleSearchInput.value = '';
        vehicleSearchInput.setAttribute('readonly', true);
      }
    }
    
    // Search drivers
    function searchDrivers(query) {
      const searchTerm = query.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredDrivers = [...allDrivers];
      } else {
        filteredDrivers = allDrivers.filter(driver => 
          driver.searchText.includes(searchTerm)
        );
      }
      
      updateDriverDropdownHeader();
      renderDriverDropdown();
    }
    
    // Search vehicles
    function searchVehicles(query) {
      const searchTerm = query.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredVehicles = [...allVehicles];
      } else {
        filteredVehicles = allVehicles.filter(vehicle => 
          vehicle.searchText.includes(searchTerm)
        );
      }
      
      updateVehicleDropdownHeader();
      renderVehicleDropdown();
    }
    
    // Update dropdown headers
    function updateDriverDropdownHeader() {
      const count = filteredDrivers.length;
      driverDropdownHeader.textContent = `Available Drivers (${count})`;
    }
    
    function updateVehicleDropdownHeader() {
      const count = filteredVehicles.length;
      vehicleDropdownHeader.textContent = `Available Vehicles (${count})`;
    }
    
    // Handle keyboard navigation for driver dropdown
    function handleDriverKeyNavigation(e) {
      const items = driverDropdownList.querySelectorAll('.dropdown-item');
      
      switch(e.key) {
        case 'ArrowDown':
          e.preventDefault();
          driverFocusedIndex = Math.min(driverFocusedIndex + 1, items.length - 1);
          updateDriverFocusedItem(items);
          break;
          
        case 'ArrowUp':
          e.preventDefault();
          driverFocusedIndex = Math.max(driverFocusedIndex - 1, -1);
          updateDriverFocusedItem(items);
          break;
          
        case 'Enter':
          e.preventDefault();
          if (driverFocusedIndex >= 0 && items[driverFocusedIndex]) {
            const driverId = items[driverFocusedIndex].dataset.driverId;
            const driver = filteredDrivers.find(d => d.id === driverId);
            if (driver) selectDriver(driver);
          }
          break;
          
        case 'Escape':
          closeDriverDropdown();
          driverSearchInput.blur();
          break;
      }
    }
    
    // Handle keyboard navigation for vehicle dropdown
    function handleVehicleKeyNavigation(e) {
      const items = vehicleDropdownList.querySelectorAll('.dropdown-item');
      
      switch(e.key) {
        case 'ArrowDown':
          e.preventDefault();
          vehicleFocusedIndex = Math.min(vehicleFocusedIndex + 1, items.length - 1);
          updateVehicleFocusedItem(items);
          break;
          
        case 'ArrowUp':
          e.preventDefault();
          vehicleFocusedIndex = Math.max(vehicleFocusedIndex - 1, -1);
          updateVehicleFocusedItem(items);
          break;
          
        case 'Enter':
          e.preventDefault();
          if (vehicleFocusedIndex >= 0 && items[vehicleFocusedIndex]) {
            const vehicleId = items[vehicleFocusedIndex].dataset.vehicleId;
            const vehicle = filteredVehicles.find(v => v.id === vehicleId);
            if (vehicle) selectVehicle(vehicle);
          }
          break;
          
        case 'Escape':
          closeVehicleDropdown();
          vehicleSearchInput.blur();
          break;
      }
    }
    
    // Update focused items
    function updateDriverFocusedItem(items) {
      items.forEach((item, index) => {
        item.classList.remove('focused');
        if (index === driverFocusedIndex) {
          item.classList.add('focused');
          item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
      });
    }
    
    function updateVehicleFocusedItem(items) {
      items.forEach((item, index) => {
        item.classList.remove('focused');
        if (index === vehicleFocusedIndex) {
          item.classList.add('focused');
          item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
      });
    }
    
    // Event listeners for driver search
    driverSearchInput.addEventListener('click', () => {
      if (!selectedDriver) {
        driverSearchInput.removeAttribute('readonly');
        openDriverDropdown();
      }
    });
    
    driverSearchInput.addEventListener('focus', () => {
      if (!selectedDriver) {
        driverSearchInput.removeAttribute('readonly');
        openDriverDropdown();
      }
    });
    
    driverSearchInput.addEventListener('input', (e) => {
      if (selectedDriver) return;
      
      const query = e.target.value;
      searchDrivers(query);
      
      if (!isDriverDropdownOpen) openDriverDropdown();
      driverFocusedIndex = -1;
    });
    
    driverSearchInput.addEventListener('keydown', handleDriverKeyNavigation);
    
    driverSearchClear.addEventListener('click', (e) => {
      e.stopPropagation();
      clearDriverSelection();
    });
    
    // Event listeners for vehicle search
    vehicleSearchInput.addEventListener('click', () => {
      if (!selectedVehicle) {
        vehicleSearchInput.removeAttribute('readonly');
        openVehicleDropdown();
      }
    });
    
    vehicleSearchInput.addEventListener('focus', () => {
      if (!selectedVehicle) {
        vehicleSearchInput.removeAttribute('readonly');
        openVehicleDropdown();
      }
    });
    
    vehicleSearchInput.addEventListener('input', (e) => {
      if (selectedVehicle) return;
      
      const query = e.target.value;
      searchVehicles(query);
      
      if (!isVehicleDropdownOpen) openVehicleDropdown();
      vehicleFocusedIndex = -1;
    });
    
    vehicleSearchInput.addEventListener('keydown', handleVehicleKeyNavigation);
    
    vehicleSearchClear.addEventListener('click', (e) => {
      e.stopPropagation();
      clearVehicleSelection();
    });
    
    // Route display update
    function updateRouteDisplay() {
      const origin = originInput.value.trim();
      const destination = destinationInput.value.trim();
      
      if (origin && destination) {
        document.getElementById('previewOrigin').textContent = origin;
        document.getElementById('previewDestination').textContent = destination;
        routeDisplay.style.display = 'flex';
      } else {
        routeDisplay.style.display = 'none';
      }
    }
    
    originInput.addEventListener('input', updateRouteDisplay);
    destinationInput.addEventListener('input', updateRouteDisplay);
    
    // Odometer validation
    function validateOdometer() {
      const startOdometer = parseInt(startOdometerInput.value) || 0;
      const endOdometer = parseInt(endOdometerInput.value) || 0;
      
      odometerWarning.style.display = 'none';
      distanceCalculation.style.display = 'none';
      
      // For manual entries, we allow any start odometer reading
      // Just show an info message if it's different from current
      if (startOdometer < selectedVehicleOdometer) {
        odometerWarning.style.display = 'block';
        odometerWarning.className = 'alert alert-info'; // Change to info instead of warning
        document.getElementById('odometerWarningText').innerHTML = 
          `<i class="fas fa-info-circle me-2"></i>Start odometer (${startOdometer}) is less than vehicle's current odometer (${selectedVehicleOdometer}). This is allowed for manual historical entries.`;
        // Don't return false - allow the entry
      }
      
      if (endOdometer && startOdometer) {
        if (endOdometer <= startOdometer) {
          odometerWarning.style.display = 'block';
          odometerWarning.className = 'odometer-warning'; // Reset to warning style
          document.getElementById('odometerWarningText').textContent = 
            `End odometer (${endOdometer}) must be greater than start odometer (${startOdometer})`;
          return false;
        } else {
          const distance = endOdometer - startOdometer;
          document.getElementById('calculatedDistance').textContent = distance;
          distanceCalculation.style.display = 'block';
        }
      }
      
      return true;
    }
    
    startOdometerInput.addEventListener('input', validateOdometer);
    endOdometerInput.addEventListener('input', validateOdometer);
    
    // Quick location buttons
    document.querySelectorAll('[data-location]').forEach(button => {
      button.addEventListener('click', function() {
        const location = this.dataset.location;
        const activeField = document.activeElement;
        
        if (activeField === originInput || activeField === destinationInput) {
          activeField.value = location;
        } else {
          // Default to origin if no field is focused
          originInput.value = location;
        }
        updateRouteDisplay();
      });
    });
    
    // Click outside to close dropdowns
    document.addEventListener('click', (e) => {
      if (!driverSearchInput.contains(e.target) && !driverDropdown.contains(e.target)) {
        closeDriverDropdown();
      }
      
      if (!vehicleSearchInput.contains(e.target) && !vehicleDropdown.contains(e.target)) {
        closeVehicleDropdown();
      }
    });
    
    // Initialize dropdowns
    updateDriverDropdownHeader();
    updateVehicleDropdownHeader();
    renderDriverDropdown();
    renderVehicleDropdown();
  });
  
  // Utility functions
  function setTimeToMorning(field) {
    const today = new Date();
    today.setHours(8, 0, 0, 0);
    const localTime = new Date(today.getTime() - today.getTimezoneOffset() * 60000);
    const timeString = localTime.toISOString().slice(0, 16);
    
    if (field === 'start') {
      document.getElementById('id_start_time').value = timeString;
    }
  }
  
  function setTimeToYesterday(field) {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    yesterday.setHours(8, 0, 0, 0);
    const localTime = new Date(yesterday.getTime() - yesterday.getTimezoneOffset() * 60000);
    
    if (field === 'start') {
      document.getElementById('id_start_time').value = localTime.toISOString().slice(0, 16);
    }
  }
  
  function loadSampleData() {
    // Set sample origin and destination
    document.getElementById('id_origin').value = 'Main Office';
    document.getElementById('id_destination').value = 'Client Site Downtown';
    document.getElementById('id_purpose').value = 'Client Meeting';
    document.getElementById('id_notes').value = 'Regular business meeting with client.';
    
    // Update route display
    document.getElementById('previewOrigin').textContent = 'Main Office';
    document.getElementById('previewDestination').textContent = 'Client Site Downtown';
    document.getElementById('routeDisplay').style.display = 'flex';
    
    // Set start time to yesterday morning
    setTimeToYesterday('start');
    
    alert('Sample data loaded! Please select a driver and vehicle to complete the form.');
  }
  
  function resetForm() {
    if (confirm('Are you sure you want to reset all fields? This action cannot be undone.')) {
      document.getElementById('manualTripForm').reset();
      
      // Clear driver selection
      const driverSearchInput = document.getElementById('driverSearchInput');
      const driverSearchClear = document.getElementById('driverSearchClear');
      const driverSearchIcon = document.getElementById('driverSearchIcon');
      const hiddenDriverField = document.getElementById('id_driver');
      
      driverSearchInput.value = '';
      driverSearchInput.classList.remove('has-value');
      driverSearchInput.setAttribute('readonly', true);
      driverSearchClear.style.display = 'none';
      driverSearchIcon.style.display = 'block';
      hiddenDriverField.value = '';
      document.getElementById('driverPreview').style.display = 'none';
      
      // Clear vehicle selection
      const vehicleSearchInput = document.getElementById('vehicleSearchInput');
      const vehicleSearchClear = document.getElementById('vehicleSearchClear');
      const vehicleSearchIcon = document.getElementById('vehicleSearchIcon');
      const hiddenVehicleField = document.getElementById('id_vehicle');
      
      vehicleSearchInput.value = '';
      vehicleSearchInput.classList.remove('has-value');
      vehicleSearchInput.setAttribute('readonly', true);
      vehicleSearchClear.style.display = 'none';
      vehicleSearchIcon.style.display = 'block';
      hiddenVehicleField.value = '';
      document.getElementById('vehiclePreview').style.display = 'none';
      
      // Hide other elements
      document.getElementById('routeDisplay').style.display = 'none';
      document.getElementById('odometerWarning').style.display = 'none';
      document.getElementById('distanceCalculation').style.display = 'none';
    }
  }
  
  function previewTrip() {
    const modal = new bootstrap.Modal(document.getElementById('tripPreviewModal'));
    const content = document.getElementById('tripPreviewContent');
    
    // Get form data
    const driverInput = document.getElementById('driverSearchInput');
    const vehicleInput = document.getElementById('vehicleSearchInput');
    const origin = document.getElementById('id_origin').value;
    const destination = document.getElementById('id_destination').value;
    const startTime = document.getElementById('id_start_time').value;
    const endTime = document.getElementById('id_end_time').value;
    const startOdometer = document.getElementById('id_start_odometer').value;
    const endOdometer = document.getElementById('id_end_odometer').value;
    const purpose = document.getElementById('id_purpose').value;
    const notes = document.getElementById('id_notes').value;
    
    const distance = endOdometer && startOdometer ? (parseInt(endOdometer) - parseInt(startOdometer)) : 'N/A';
    const status = endTime && endOdometer ? 'Completed' : 'Ongoing';
    
    content.innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <h6>Driver Information</h6>
          <p><strong>Driver:</strong> ${driverInput.value || 'Not selected'}</p>
          
          <h6>Vehicle Information</h6>
          <p><strong>Vehicle:</strong> ${vehicleInput.value || 'Not selected'}</p>
          
          <h6>Route Information</h6>
          <p><strong>From:</strong> ${origin || 'Not entered'}</p>
          <p><strong>To:</strong> ${destination || 'Not entered'}</p>
        </div>
        <div class="col-md-6">
          <h6>Trip Timing</h6>
          <p><strong>Start:</strong> ${startTime ? new Date(startTime).toLocaleString() : 'Not set'}</p>
          <p><strong>End:</strong> ${endTime ? new Date(endTime).toLocaleString() : 'Ongoing'}</p>
          
          <h6>Odometer Readings</h6>
          <p><strong>Start:</strong> ${startOdometer || 'Not entered'} km</p>
          <p><strong>End:</strong> ${endOdometer || 'Not entered'} km</p>
          <p><strong>Distance:</strong> ${distance} km</p>
          
          <h6>Trip Details</h6>
          <p><strong>Purpose:</strong> ${purpose || 'Not entered'}</p>
          <p><strong>Status:</strong> <span class="badge bg-${status === 'Completed' ? 'success' : 'warning'}">${status}</span></p>
        </div>
      </div>
      ${notes ? `<div class="mt-3"><h6>Notes</h6><p>${notes}</p></div>` : ''}
    `;
    
    modal.show();
  }
</script>
{% endblock %}
